#!/bin/bash

######################################################################
#           Auto Install & Optimize LEMP Stack on Ubuntu             #
#                                                                    #
#                Author: TinyActive - Base On HOSTVN.VN Scripts      #
#                  Website: https://github.com/TinyActive/panel      #
#                                                                    #
#              Please do not remove copyright. Thank!                #
#  Please do not copy under any circumstance for commercial reason!  #
######################################################################

source /var/hostvn/menu/validate/rule
source /var/hostvn/menu/helpers/function

_domain_action(){
    clear
    printf "%s\n" "Lua chon thao tac ban muon thuc hien"
    PS3="Nhap vao lua chon cua ban [ 1 - 3 ]: "
    options=("Bat Varnish cho domain" "Tat Varnish cho domain" "Xem danh sach domain" "Cancel")
    select opt in "${options[@]}"; do
        case $opt in
        "Tat Varnish cho domain")
            action="disable"
            break
            ;;
        "Bat Varnish cho domain")
            action="enable"
            break
            ;;
        "Xem danh sach domain")
            action="list"
            break
            ;;
        "Cancel")
            action="cancel"
            break
            ;;
        *) printf "${RED}%s${NC}\n" "Lua chon cua ban khong chinh xac. Vui long chon lai. $REPLY" ;;
        esac
    done
    sleep 1
}

_select_domain_enable() {
    domain=""
    if [[ "$(ls -A "${USER_DIR}")" ]]; then
        domains=()
        echo "${LIST_DOMAIN}"
        _cd_dir "${USER_DIR}"
        for entry in .*.conf; do
            domain=${entry/./}
            domain=${domain//.conf/}
            check_varnish=$(grep -w "varnish_enabled=yes" "${USER_DIR}/.${domain}.conf" 2>/dev/null)
            if [[ -z "${check_varnish}" ]]; then
                domains+=("${domain}")
            fi
        done
        if [ ${#domains[@]} -eq 0 ]; then
            ALERT=$(printf "%s\n" "${RED}Tat ca cac website deu da duoc cau hinh Varnish Cache.${NC}")
        else
            echo "Lua chon website"
            PS3="${INPUT_SELECT} [0 = Thoat]: "
            select opt in "${domains[@]}"; do
                domain=$opt
                break
            done
        fi
    else
        ALERT=$(printf "%s\n" "${RED}${EMPTY_DOMAIN}${NC}")
    fi
}

_select_domain_disable() {
    domain=""
    if [[ "$(ls -A "${USER_DIR}")" ]]; then
        domains=()
        echo "${LIST_DOMAIN}"
        _cd_dir "${USER_DIR}"
        for entry in .*.conf; do
            domain=${entry/./}
            domain=${domain//.conf/}
            check_varnish=$(grep -w "varnish_enabled=yes" "${USER_DIR}/.${domain}.conf" 2>/dev/null)
            if [[ -n "${check_varnish}" ]]; then
                domains+=("${domain}")
            fi
        done
        if [ ${#domains[@]} -eq 0 ]; then
            ALERT=$(printf "%s\n" "${RED}Chua co website nao duoc cau hinh Varnish Cache.${NC}")
        else
            echo "Lua chon website"
            PS3="${INPUT_SELECT} [0 = Thoat]: "
            select opt in "${domains[@]}"; do
                domain=$opt
                break
            done
        fi
    else
        ALERT=$(printf "%s\n" "${RED}${EMPTY_DOMAIN}${NC}")
    fi
}

_list_varnish_domains() {
    if [[ "$(ls -A "${USER_DIR}")" ]]; then
        printf "%s\n" "${GREEN}=== DANH SACH DOMAIN SU DUNG VARNISH ===${NC}"
        printf "%-30s %-15s\n" "DOMAIN" "TRANG THAI"
        printf "%s\n" "=============================================="
        
        _cd_dir "${USER_DIR}"
        for entry in .*.conf; do
            domain=${entry/./}
            domain=${domain//.conf/}
            check_varnish=$(grep -w "varnish_enabled=yes" "${USER_DIR}/.${domain}.conf" 2>/dev/null)
            if [[ -n "${check_varnish}" ]]; then
                printf "%-30s ${GREEN}%-15s${NC}\n" "${domain}" "BAT"
            else
                printf "%-30s ${RED}%-15s${NC}\n" "${domain}" "TAT"
            fi
        done
        printf "%s\n" "=============================================="
    else
        printf "%s\n" "${RED}Khong co domain nao.${NC}"
    fi
    
    printf "%s\n" ""
    read -r -p "Nhan Enter de tiep tuc..."
}

_confirm_enable() {
    while true; do
        read -r -p "Ban co muon bat Varnish Cache cho website ${domain} khong (y/n)? " prompt_enable
        echo
        if [[ "${prompt_enable}" =~ ^([yY])$ || "${prompt_enable}" =~ ^([nN])$ ]]; then
            break
        else
            printf "%s\n" "${RED}Lua chon cua ban khong chinh xac. Vui long nhap lai.${NC}"
        fi
    done
}

_confirm_disable() {
    while true; do
        read -r -p "Ban muon tat Varnish Cache cho website ${domain} (y/n)? " prompt_disable
        echo
        if [[ "${prompt_disable}" =~ ^([yY])$ || "${prompt_disable}" =~ ^([nN])$ ]]; then
            break
        else
            printf "%s\n" "${RED}Lua chon cua ban khong chinh xac. Vui long nhap lai.${NC}"
        fi
    done
}

_enable_varnish_domain() {
    user=$(grep -w "username" "${USER_DIR}/.${domain}.conf" | cut -f2 -d'=')
    
    # Backup current vhost
    cp "${VHOST_DIR}/${domain}.conf" "${VHOST_DIR}/${domain}.conf.pre-varnish"
    
    # Modify vhost to listen on port 8080 (backend) instead of 80
    sed -i 's/listen 80;/listen 8080;/g' "${VHOST_DIR}/${domain}.conf"
    sed -i 's/listen \[::\]:80;/listen [::]:8080;/g' "${VHOST_DIR}/${domain}.conf"
    sed -i 's/listen 80 /listen 8080 /g' "${VHOST_DIR}/${domain}.conf"
    
    # Remove any default_server directive (frontend will handle this)
    sed -i 's/listen 8080 default_server;/listen 8080;/g' "${VHOST_DIR}/${domain}.conf"
    
    # Add backend marker comment
    if ! grep -q "# Varnish Backend Configuration" "${VHOST_DIR}/${domain}.conf"; then
        sed -i '1i# Varnish Backend Configuration - Listen on port 8080' "${VHOST_DIR}/${domain}.conf"
    fi
    
    # Create SSL termination frontend using template
    template_content=$(cat "${SCRIPT_ROOT}/menu/template/varnish_frontend.conf")
    
    # Replace domain name in template
    template_content="${template_content//DOMAIN_NAME/${domain}}"
    
    # Check if domain has SSL certificate
    ssl_cert_path=""
    ssl_key_path=""
    
    if [ -f "/etc/nginx/ssl/${domain}/${domain}.crt" ] && [ -f "/etc/nginx/ssl/${domain}/${domain}.key" ]; then
        ssl_cert_path="/etc/nginx/ssl/${domain}/${domain}.crt"
        ssl_key_path="/etc/nginx/ssl/${domain}/${domain}.key"
    elif [ -f "/etc/letsencrypt/live/${domain}/fullchain.pem" ] && [ -f "/etc/letsencrypt/live/${domain}/privkey.pem" ]; then
        ssl_cert_path="/etc/letsencrypt/live/${domain}/fullchain.pem"
        ssl_key_path="/etc/letsencrypt/live/${domain}/privkey.pem"
    else
        # Use default SSL certificate
        ssl_cert_path="/etc/nginx/ssl/default.crt"
        ssl_key_path="/etc/nginx/ssl/default.key"
    fi
    
    # Replace SSL paths in template
    template_content="${template_content//SSL_CERT_PATH/${ssl_cert_path}}"
    template_content="${template_content//SSL_KEY_PATH/${ssl_key_path}}"
    
    # Write frontend configuration
    echo "${template_content}" > "${VHOST_DIR}/${domain}_frontend.conf"
    
    # Remove the old vhost file from sites-enabled temporarily during transition
    if [ -L "/etc/nginx/sites-enabled/${domain}.conf" ]; then
        rm -f "/etc/nginx/sites-enabled/${domain}.conf"
    fi
    
    # Create new symlink for backend config
    if [ ! -L "/etc/nginx/sites-enabled/${domain}.conf" ]; then
        ln -s "${VHOST_DIR}/${domain}.conf" "/etc/nginx/sites-enabled/${domain}.conf"
    fi
    
    # Create symlink for frontend config
    if [ ! -L "/etc/nginx/sites-enabled/${domain}_frontend.conf" ]; then
        ln -s "${VHOST_DIR}/${domain}_frontend.conf" "/etc/nginx/sites-enabled/${domain}_frontend.conf"
    fi
EOvarnish_vhost
    
    # Mark domain as Varnish enabled
    sed -i '/varnish_enabled=/d' "${USER_DIR}/.${domain}.conf"
    echo "varnish_enabled=yes" >> "${USER_DIR}/.${domain}.conf"
    
    notify="Bat Varnish Cache cho domain ${domain} thanh cong."
}

_disable_varnish_domain() {
    user=$(grep -w "username" "${USER_DIR}/.${domain}.conf" | cut -f2 -d'=')
    
    # Remove frontend configuration
    if [ -f "${VHOST_DIR}/${domain}_frontend.conf" ]; then
        rm -f "${VHOST_DIR}/${domain}_frontend.conf"
    fi
    
    # Remove frontend symlink
    if [ -L "/etc/nginx/sites-enabled/${domain}_frontend.conf" ]; then
        rm -f "/etc/nginx/sites-enabled/${domain}_frontend.conf"
    fi
    
    # Restore original vhost configuration
    if [ -f "${VHOST_DIR}/${domain}.conf.pre-varnish" ]; then
        cp "${VHOST_DIR}/${domain}.conf.pre-varnish" "${VHOST_DIR}/${domain}.conf"
        rm -f "${VHOST_DIR}/${domain}.conf.pre-varnish"
    else
        # Fallback: change port back to 80 and remove backend comment
        sed -i 's/listen 8080;/listen 80;/g' "${VHOST_DIR}/${domain}.conf"
        sed -i 's/listen \[::\]:8080;/listen [::]:80;/g' "${VHOST_DIR}/${domain}.conf"
        sed -i 's/listen 8080 /listen 80 /g' "${VHOST_DIR}/${domain}.conf"
        sed -i '/# Varnish Backend Configuration/d' "${VHOST_DIR}/${domain}.conf"
    fi
    
    # Ensure backend symlink exists
    if [ ! -L "/etc/nginx/sites-enabled/${domain}.conf" ]; then
        ln -s "${VHOST_DIR}/${domain}.conf" "/etc/nginx/sites-enabled/${domain}.conf"
    fi
    
    # Mark domain as Varnish disabled
    sed -i '/varnish_enabled=/d' "${USER_DIR}/.${domain}.conf"
    echo "varnish_enabled=no" >> "${USER_DIR}/.${domain}.conf"
    
    notify="Tat Varnish Cache cho domain ${domain} thanh cong."
}

_run() {
    if [ "${action}" == "enable" ]; then
        _confirm_enable
        if [[ "${prompt_enable}" =~ ^([yY])$ ]]; then
            _enable_varnish_domain
        else
            ALERT=$(printf "%s\n" "${RED}Huy thao tac.${NC}")
        fi
    elif [ "${action}" == "disable" ]; then
        _confirm_disable
        if [[ "${prompt_disable}" =~ ^([yY])$ ]]; then
            _disable_varnish_domain
        else
            ALERT=$(printf "%s\n" "${RED}Huy thao tac.${NC}")
        fi
    elif [ "${action}" == "list" ]; then
        _list_varnish_domains
        notify=""
    fi

    if [ -z "${ALERT}" ] && [ -n "${notify}" ]; then
        if nginx -t; then
            _restart_service
            clear
            printf "%s\n" "${GREEN}${notify}${NC}"
        else
            clear
            nginx -t
            printf "%s\n" "${RED}${lang_error_vhost}${NC}"
            printf "%s\n" "${RED}${lang_use_rewrite_config}${NC}"
        fi
    elif [ -n "${ALERT}" ]; then
        clear
        printf "%s\n" "${ALERT}"
    fi
}

domain=""
ALERT=""
action=""
notify=""

_domain_action

if [[ -z "${action}" || "${action}" == "cancel" ]]; then
    clear
    printf "${RED}%s${NC}\n" "Huy thao tac."
else
    if [ "${action}" == "enable" ]; then
        _select_domain_enable
    elif [ "${action}" == "disable" ]; then
        _select_domain_disable
    elif [ "${action}" == "list" ]; then
        _list_varnish_domains
        menu_cache
        exit 0
    fi

    if [[ -z "${domain}" && -z "${ALERT}" ]]; then
        clear
        printf "%s\n" "${RED}Ban da chon huy thao tac${NC}"
    else
        if [ -z "${ALERT}" ]; then
            _run
        else
            clear
            printf "%s\n" "${ALERT}"
        fi
    fi
fi

menu_cache
